{% extends "./layout.html" %}

{% load staticfiles %}
{% load utils %}
{% load render_table from django_tables2 %}

{% block content %}
  <section id="addressbook">
    <style>
      table th a i.fa-sort{
        display: none;
      }
      table th a:hover i.fa-sort{
        display: inline-block;
      }

      table td a{
        color: #2d9972;
      }

      .family-menu{
        text-align: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }

      .family-menu a{
        margin: auto 8px;
        font-weight: bold;
        font-size: 140%;
      }
      
      .family-menu a:hover{
        text-decoration: underline;
      }

      .family-picture{
        width: 100%;
      }

      .family-list .family-list-details{
        display: none;
      }

      .family-list .family-list-header{
        margin-top: 20px;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .favorite div{
        cursor: pointer;
        display: inline-block;
      }
      
      .favorite div i.fa{
        float: left;
      }

      .favorite div:hover :not(.fa-star-half-o){
        display: none;
      }

      .favorite div:hover .fa-star-half-o{
        display: block;
      }

      .favorite div .fa-star-half-o{
        display: none;
      }

      .google-maps-link{
        font-size: 80%;
        margin-left: 5px;
      }

      .search-form label{
        margin: auto 8px;
        cursor: pointer;
      }
    </style>
    <div class="container-fluid">
      <div class="row">
        <h1>Adresboek</h1>

        {% if messages %}
          <!-- Status messages -->
          <ul class="messages">
            {% for message in messages %}
              <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}

        <!-- Addressbook menu/choices -->
        <div class="col-sm-12">
          <ul class="nav nav-tabs">
            <li role="presentation" title="Add another splittable" {% if page == 'persons' %}class="active"{% endif %}><a href="{% url 'addressbook-detail' "persons" %}">Personen</a></li>
            <li role="presentation" title="Add another splittable" {% if page == 'families' %}class="active"{% endif %}><a href="{% url 'addressbook-detail' "families" %}">Families</a></li>
            <li role="presentation" title="Add another splittable" {% if page == 'search' %}class="active"{% endif %}><a href="{% url 'addressbook-detail' "search" %}">Zoeken</a></li>
            <li role="presentation" title="Add another splittable" {% if page == 'favorites' %}class="active"{% endif %}><a href="{% url 'addressbook-detail' "favorites" %}">Favorieten</a></li>
          </ul>

          <!-- Addressbook list -->
          {% if page == 'persons' or page == 'favorites' %}
            <!-- Persons page -->
            {% render_table data %}

          {% elif page == 'families' %}
            <!-- Family page -->
            <!-- Alphabetic list -->
            <div class="family-menu">
            {% for v in data %}
              {% ifchanged v.lastname.0 %}
                <a href="#{{ v.lastname.0 }}">{{ v.lastname.0 }}</a>
              {% endifchanged %}
            {% endfor %}
            </div>

            <!-- Family list -->
            <div class="list-group family-list">
            {% for v in data %}
              {% ifchanged v.lastname.0 %}<div class="family-list-header" id="{{ v.lastname.0 }}">{{ v.lastname.0 }}</div>{% endifchanged %}
              <a href="javascript:void(0)" class="list-group-item family-list-item" id="{{ v.pk }}">{{ v }}</a>

              <div class="row family-list-details" data-family-pk="{{ v.pk }}" {% if extra == v.pk %}style="display: block"{% endif %}>
                <div class="col-lg-8">
                  <!-- Some familymember + details -->
                  <table class="table table-hover">
                    <tr>
                      <th>Voornaam</th>
                      <th>Geboortedatum</th>
                      <th>Mobiele telefoon</th>
                      <th> </th>
                    </tr>
                    {% for w in v.members.all %}
                      <tr>
                        <td><a href="{% url 'profile' w.user.pk %}">{{ w.user.first_name }}</a></td>
                        <td>{{ w.user.profile.birthday }}</td>
                        <td>{{ w.user.profile.phone }}</td>
                        <td class="favorite"><div data-user-pk="{{ w.user.pk }}" title="{% if not w.user.profile.isfavorite %}Voeg toe aan{% else %}Verwijder van{% endif %} favorieten"><i class="fa fa-star{% if not w.user.profile.isfavorite %}-o{% endif %}"></i><i class="fa fa-star-half-o"></i></div></td>
                      </tr>
                    {% endfor %}

                    <!-- Contact info -->
                    <tr>
                      <td>
                        <strong>Adres</strong> <a href="http://www.google.com/maps/place/{{ v.members.all.0.user.profile.address }}" target="_blank" title="Bekijk op Google Maps" class="google-maps-link"><i class="fa fa-external-link"></i></a><br/>
                        {{ v.members.all.0.user.profile.address.street }}<br/>
                        {{ v.members.all.0.user.profile.address.zip }}, {{ v.members.all.0.user.profile.address.city }}
                      </td>
                      <td>
                        <strong>Telefoon</strong><br/>
                        {{ v.members.all.0.user.profile.address.phone }}
                      </td>
                      <td></td>
                    </tr>
                  </table>

                </div>

                <div class="col-lg-4">
                  <!-- Place for the family photo -->
                  <!-- Todo: load image only when needed/clicked, not all images of all the families at the same time -->
                  <img src="http://blog.novakdjokovicfoundation.org/media/2014/06/shutterstock_151928681.jpg" atr="Foto van de familie {{ v.lastname }}" class="family-picture"/>
                </div>
              </div>
            {% endfor %}
            </div>

          {% elif page == 'search' %}
            <!-- Search page -->
            <form method="post" action="{% url 'addressbook-detail' 'search'%}" class="search-form">
              {% csrf_token %}
              <input type="text" name="search" value="{% if extra %}{{ extra.0 }}{% endif %}" autocomplete="off" placeholder="Zoekterm" autofocus/>
              <button type="submit"><i class="fa fa-search"></i></button><br/>
              Zoeken op:
              <label><input type="checkbox" name="fields[]" value="first_name" {% if extra and 'first_name' in extra or not extra %}checked{% endif %}/> Voornaam</label>
              <label><input type="checkbox" name="fields[]" value="last_name" {% if extra and 'last_name' in extra or not extra %}checked{% endif %}/> Achternaam</label>
              <label><input type="checkbox" name="fields[]" value="address" {% if extra and 'address' in extra %}checked{% endif %}/> Adres</label>
            </form>

            <br/>
            {% if extra %}
              <!-- Display result -->
              {% if data %}
                <strong>Results for </strong>{{ extra.0 }}<strong> :</strong>
                <div class="search-results">
                  {% render_table data %}
                </div>
              {% else %}
                No matches found...
              {% endif %}
            {% endif %}

          {% endif %}
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script>
    $(function(){
      $('.family-list .family-list-item').click(function(){
        $('.family-list .family-list-details[data-family-pk=' + $(this).attr('id') + ']').slideToggle(100);
      });

      $('.favorite div').click(function(){
        alert('Gonna add them to ya favorites! Yeah-yeah jingle-yeah! Btw, the id is: ' + $(this).attr('data-user-pk'));

        // Submit a request to make that user a favorite (or not)
        $.ajax({
          data: {id: $(this).attr('data-user-pk')},
          type: 'GET',
          url: '{% url 'addressbook-post' 'favorites' 'submit' %}',
        }).done(function(m){
          if(m.hasErrors === false) {
            // Reload page, because I'm to lazy to reload the table
            location.reload();
          }else{
            console.log("Something went a little bit wrong :/");
          }
        })
      })

      {% if page == 'families' and extra %}
        // Scroll to the family details div
        $(document.body).animate({
          scrollTop: $('#{{ extra }}').offset().top
        }, 500);
      {% endif %}
    })
  </script>
{% endblock %}